<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Auto Jadual Sekolah (Auto-Generate)</title>
<meta name="theme-color" content="#0f172a">
<style>
  :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;--border:#233046}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Arial;background:var(--bg);color:var(--text)}
  .container{max-width:1200px;margin:0 auto;padding:18px}
  header{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:10px}
  h1{font-size:18px;margin:0}
  .grid{display:grid;gap:12px}
  .cols-2{grid-template-columns:1.15fr 1fr}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
  label{font-size:12px;color:var(--muted)}
  input,select,button{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:var(--text);font-size:14px}
  input[type="number"]{appearance:textfield}
  button{cursor:pointer;font-weight:600}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
  .row4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px}
  .muted{color:var(--muted);font-size:12px}
  .actions{display:flex;flex-wrap:wrap;gap:8px}
  .accent{background:var(--accent);border-color:#16a34a;color:#052e16}
  .chips{display:flex;flex-wrap:wrap;gap:6px}
  .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:#0b1220;font-size:12px}
  .chip input{width:auto}
  .table-wrap{overflow:auto}
  table{width:100%;min-width:860px;border-collapse:separate;border-spacing:0}
  th,td{border:1px solid var(--border);padding:8px 10px;text-align:center}
  th{position:sticky;top:0;background:#0b1220;z-index:1}
  td.editable{cursor:text}
  .recess{background:#052e16}
  .fixed{background:#111b2e}
  details>summary{cursor:pointer;margin:6px 0;padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:#0b1220}
  .subj-row{display:grid;grid-template-columns:1fr 90px 120px 110px 28px;gap:8px;align-items:center}
  .badge{font-size:11px;border:1px solid var(--border);border-radius:999px;padding:2px 8px;color:var(--muted)}
  @media (max-width:1000px){.cols-2{grid-template-columns:1fr}}
  @media print{.no-print{display:none!important} body{background:#fff;color:#000} table,th,td{border:1px solid #000} th{background:#f3f4f6;color:#000}}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>ðŸ“š Auto Jana Jadual â€“ Sekolah Rendah</h1>
    <div class="no-print" style="display:flex;gap:6px;align-items:center">
      <span class="badge">Auto-generate aktif</span>
      <span class="badge">Dibangunkan oleh Lisa Â· Powered by Sukor Rija Legacy</span>
    </div>
  </header>

  <div class="grid cols-2">
    <!-- KIRI: Tetapan & Input -->
    <section class="card">
      <div class="row">
        <div>
          <label>Nama Murid</label>
          <input id="nama" placeholder="Contoh: Aisyah Humaira">
        </div>
        <div>
          <label>Kelas / Darjah</label>
          <input id="kelas" placeholder="Contoh: 5 Cemerlang">
        </div>
      </div>

      <div class="row3">
        <div>
          <label>Sesi</label>
          <select id="sesi">
            <option value="pagi">Pagi</option>
            <option value="petang">Petang</option>
          </select>
        </div>
        <div>
          <label>Mula (HH:MM)</label>
          <input id="masaMula" type="time" value="07:30">
        </div>
        <div>
          <label>Panjang Satu Waktu (minit) <span class="muted">(global)</span></label>
          <input id="panjangWaktu" type="number" min="20" value="30">
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Hari Bersekolah</label>
        <div id="hariChips" class="chips no-print"></div>
        <div class="muted">Tanda hari yang digunakan. Jadual dijana mengikut hari bertanda.</div>
      </div>

      <div class="row3" style="margin-top:10px">
        <div>
          <label>Bil. Waktu Sehari (tak termasuk Rehat)</label>
          <input id="bilWaktu" type="number" min="4" value="8">
        </div>
        <div>
          <label>Masa Rehat (minit)</label>
          <input id="minRehat" type="number" min="10" value="30">
        </div>
        <div>
          <label>Rehat Selepas Waktu Ke-</label>
          <input id="rehatSelepas" type="number" min="1" value="3">
        </div>
      </div>

      <details style="margin-top:10px">
        <summary>âž• Slot Tetap (perhimpunan / PJ / ko-ku)</summary>
        <div id="slotTetapList" style="margin-top:8px"></div>
        <div class="actions">
          <button class="no-print" onclick="addFixedSlot()">Tambah Slot Tetap</button>
          <button class="no-print" onclick="clearFixedSlots()">Buang Semua</button>
        </div>
      </details>

      <h3 style="margin:12px 0 6px 0;font-size:16px">Subjek & Kekerapan</h3>
      <div class="muted">Isi nama subjek, kekerapan seminggu, dan (jika perlu) tempoh khas subjek. Kosongkan tempoh khas untuk guna tempoh global.</div>
      <div id="subjekList" style="margin-top:8px"></div>
      <div class="actions">
        <button class="no-print" onclick="addSubject()">Tambah Subjek</button>
        <button class="no-print" onclick="resetSubjects()">Reset Contoh</button>
      </div>

      <hr style="border:0;border-top:1px solid var(--border);margin:12px 0">

      <div class="actions">
        <button class="no-print accent" onclick="manualGenerate()">Jana Semula (Manual)</button>
        <button class="no-print" onclick="saveState()">Simpan (Peranti)</button>
        <button class="no-print" onclick="loadState()">Buka Simpanan</button>
        <button class="no-print" onclick="exportJSON()">Export JSON</button>
        <button class="no-print" onclick="importJSON()">Import JSON</button>
      </div>
      <div class="actions" style="margin-top:8px">
        <button class="no-print" onclick="window.print()">Cetak / PDF</button>
        <button class="no-print" onclick="shareWhatsApp()">Kongsi WhatsApp</button>
        <button class="no-print" onclick="clearAll()">Kosongkan Semua</button>
      </div>
      <p class="muted" style="margin-top:6px">Auto-generate aktif: jadual dijana semula setiap kali Sukor ubah tetapan / subjek / slot tetap.</p>
    </section>

    <!-- KANAN: Output Jadual -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <div><span class="muted">Nama:</span> <b id="outNama">â€”</b></div>
          <div><span class="muted">Kelas:</span> <b id="outKelas">â€”</b></div>
        </div>
        <div><span class="muted">Sesi:</span> <b id="outSesi">â€”</b></div>
      </div>
      <div class="table-wrap">
        <table id="jadual"></table>
      </div>
    </section>
  </div>

  <p class="muted" style="margin-top:10px">
    Heuristik: elak subjek sama berturut-turut, utamakan BM/BI/Math/Sains awal hari, seni/PJ di hujung bila sesuai, patuh slot tetap & rehat.
    Semua sel boleh <b>klik & edit</b> selepas dijana.
  </p>
</div>

<script>
/* ===== Util ===== */
const HARI_DEFAULT=['Isnin','Selasa','Rabu','Khamis','Jumaat'];
function toMin(hhmm){const[a,b]=hhmm.split(':').map(Number);return a*60+b}
function fm(min){const h=Math.floor(min/60),m=min%60;return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')}
function el(tag,attrs={},kids=[]){const e=document.createElement(tag);Object.entries(attrs).forEach(([k,v])=>e[k]=v);(Array.isArray(kids)?kids:[kids]).forEach(c=>{if(c==null)return;typeof c==='string'?e.appendChild(document.createTextNode(c)):e.appendChild(c)});return e}
function deep(x){return JSON.parse(JSON.stringify(x))}

/* ===== State ===== */
let hariAktif = new Set(HARI_DEFAULT);     // boleh buang/ tambah hari
let fixedSlots=[]; // {hariIndex,waktuIndex,nama}
let subjects=[];

/* ===== Defaults ===== */
function defaultSubjects(){
  return [
    {nama:'Bahasa Melayu', kekerapan:6, teras:true, tempoh:null},
    {nama:'Bahasa Inggeris', kekerapan:5, teras:true, tempoh:null},
    {nama:'Matematik', kekerapan:5, teras:true, tempoh:null},
    {nama:'Sains', kekerapan:4, teras:true, tempoh:null},
    {nama:'Pendidikan Islam / Moral', kekerapan:3, teras:false, tempoh:null},
    {nama:'Sejarah', kekerapan:2, teras:false, tempoh:null},
    {nama:'Seni', kekerapan:2, teras:false, tempoh:null},
    {nama:'Pendidikan Jasmani', kekerapan:2, teras:false, tempoh:40},
  ];
}

/* ===== UI Render ===== */
function renderHariChips(){
  const box=document.getElementById('hariChips');
  box.innerHTML='';
  HARI_DEFAULT.forEach((h,i)=>{
    const chip=el('label',{className:'chip'},[
      el('input',{type:'checkbox',checked:hariAktif.has(h),onchange:(e)=>{ e.target.checked?hariAktif.add(h):hariAktif.delete(h); autoGenerate(); }}),
      h
    ]);
    box.appendChild(chip);
  });
}

function renderSubjects(){
  const wrap=document.getElementById('subjekList'); wrap.innerHTML='';
  subjects.forEach((s,idx)=>{
    const row=el('div',{className:'subj-row'});
    const n=el('input',{value:s.nama,placeholder:'Nama subjek',oninput:e=>{s.nama=e.target.value;autoGenerate()}});
    const k=el('input',{type:'number',min:1,value:s.kekerapan,oninput:e=>{s.kekerapan=parseInt(e.target.value||'0');autoGenerate()}});
    const t=el('select',{onchange:e=>{s.teras=(e.target.value==='true');autoGenerate()}},[
      el('option',{value:'true',selected:s.teras},'Teras'),
      el('option',{value:'false',selected:!s.teras},'Bukan Teras'),
    ]);
    const p=el('input',{type:'number',min:10,placeholder:'min (opsyenal)',value:s.tempoh??'',oninput:e=>{const v=e.target.value; s.tempoh=v===''?null:parseInt(v); autoGenerate();}});
    const del=el('button',{title:'Padam',onclick:()=>{subjects.splice(idx,1);renderSubjects();autoGenerate()}},'âœ•');
    row.append(n,k,t,p,del);
    wrap.appendChild(row);
  });
}
function addSubject(){ subjects.push({nama:'Subjek Baru',kekerapan:1,teras:false,tempoh:null}); renderSubjects(); autoGenerate(); }
function resetSubjects(){ subjects=defaultSubjects(); renderSubjects(); autoGenerate(); }

function renderFixedSlots(){
  const box=document.getElementById('slotTetapList'); box.innerHTML='';
  fixedSlots.forEach((s,idx)=>{
    const row=el('div',{className:'row4'});
    const hariSel=el('select',{value:s.hariIndex,onchange:e=>{s.hariIndex=parseInt(e.target.value);autoGenerate()}},
      HARI_DEFAULT.map((h,i)=> el('option',{value:i,selected:i===s.hariIndex},h)));
    const waktu=el('input',{type:'number',min:1,value:s.waktuIndex+1,oninput:e=>{s.waktuIndex=Math.max(0,(parseInt(e.target.value)||1)-1);autoGenerate()}});
    const nama=el('input',{value:s.nama,placeholder:'Contoh: Perhimpunan',oninput:e=>{s.nama=e.target.value;autoGenerate()}});
    const del=el('button',{onclick:()=>{fixedSlots.splice(idx,1);renderFixedSlots();autoGenerate()}},'Padam');
    row.append(el('div',{},[el('label',{},'Hari'),hariSel]),
               el('div',{},[el('label',{},'Waktu Ke-'),waktu]),
               el('div',{},[el('label',{},'Nama Slot'),nama]),
               el('div',{},[el('label',{},' '),del]));
    box.appendChild(row);
  });
}
function addFixedSlot(){ fixedSlots.push({hariIndex:0,waktuIndex:0,nama:'Perhimpunan'}); renderFixedSlots(); autoGenerate(); }
function clearFixedSlots(){ fixedSlots=[]; renderFixedSlots(); autoGenerate(); }

/* ===== Time Slots ===== */
function buildSlotsForDay(globalStart, globalLen, nPeriods, rehatMin, rehatAfter, dayIndex){
  // Per-subject tempoh khas disokong pada tahap per-penempatan (kita tetap paparkan masa grid berdasarkan globalLen + rehat)
  const slots=[];
  let t=globalStart;
  for(let i=1;i<=nPeriods;i++){
    if(i===rehatAfter+1){
      slots.push({label:'REHAT', start:fm(t), end:fm(t+rehatMin), type:'recess', dur:rehatMin});
      t+=rehatMin;
    }
    slots.push({label:`Waktu ${i}`, start:fm(t), end:fm(t+globalLen), type:'period', dur:globalLen});
    t+=globalLen;
  }
  return slots;
}

/* ===== Planner ===== */
function planWeek(){
  // Meta
  const start = toMin(document.getElementById('masaMula').value);
  const len = parseInt(document.getElementById('panjangWaktu').value);
  const n = parseInt(document.getElementById('bilWaktu').value);
  const rehatMin = parseInt(document.getElementById('minRehat').value);
  const rehatAfter = Math.min(Math.max(1, parseInt(document.getElementById('rehatSelepas').value)), Math.max(1,n-1));

  // Hari aktif (map ke index asal untuk slot tetap)
  const days = HARI_DEFAULT.map((h,i)=>({name:h,origIndex:i})).filter(d=>hariAktif.has(d.name));
  if(days.length===0) return {days:[], slotsPerDay:[], grid:[]};

  // Bina slots untuk setiap hari
  const slotsPerDay = days.map((d)=> buildSlotsForDay(start,len,n,rehatMin,rehatAfter,d.origIndex));

  // Grid kosong
  const grid = days.map((_,di)=> slotsPerDay[di].map(s=> s.type==='recess'? {type:'recess',text:'REHAT'} : {type:'period',text:''}));

  // Letak slot tetap (hormat hari aktif)
  fixedSlots.forEach(fs=>{
    const di = days.findIndex(d=>d.origIndex===fs.hariIndex);
    if(di<0) return;
    // cari indeks 'period' ke-N
    let pCount=0;
    for(let idx=0; idx<slotsPerDay[di].length; idx++){
      if(slotsPerDay[di][idx].type==='period'){
        if(pCount===fs.waktuIndex){ grid[di][idx]={type:'fixed',text:fs.nama}; break; }
        pCount++;
      }
    }
  });

  // Pool subjek ikut kekerapan
  const pool=[];
  subjects.forEach(s=>{ for(let i=0;i<s.kekerapan;i++) pool.push({nama:s.nama,teras:!!s.teras,tempoh:s.tempoh}) });
  // Keutamaan: teras dulu
  pool.sort((a,b)=>(b.teras?1:0)-(a.teras?1:0));

  // Heuristik canPlace
  function canPlace(di, si, nama){
    const cell=grid[di][si];
    if(cell.type!=='period' || cell.text) return false;
    const L = si>0? grid[di][si-1]:null;
    const R = si<grid[di].length-1? grid[di][si+1]:null;
    if(L && L.text===nama) return false;
    if(R && R.text===nama) return true;
    return true;
  }

  // Susunan slot: awal dahulu
  const orderIndex = [...Array(grid[0].length).keys()];

  // Isi
  let guard=0;
  while(pool.length && guard<6000){
    guard++;
    const it = pool.shift();
    let placed=false;

    // cuba letak ikut preferensi (teras awal, bukan teras lewat)
    const prefer = (si)=> it.teras ? si < Math.floor(orderIndex.length/2) : si >= Math.floor(orderIndex.length/2);

    for(let di=0; di<days.length && !placed; di++){
      for(const si of orderIndex){
        if(prefer(si) && canPlace(di,si,it.nama)){ grid[di][si].text=it.nama; placed=true; break; }
      }
    }
    if(!placed){
      // mana-mana lubang
      outer: for(let di=0; di<days.length; di++){
        for(let si=0; si<grid[di].length; si++){
          if(canPlace(di,si,it.nama)){ grid[di][si].text=it.nama; placed=true; break outer; }
        }
      }
    }
    if(!placed){
      // parkir di hujung minggu terakhir
      for(let si=grid[days.length-1].length-1; si>=0; si--){
        if(canPlace(days.length-1,si,it.nama)){ grid[days.length-1][si].text=it.nama; placed=true; break; }
      }
    }
  }

  return {days, slotsPerDay, grid};
}

/* ===== Render Table ===== */
function renderTable(plan){
  document.getElementById('outNama').textContent = document.getElementById('nama').value || 'â€”';
  document.getElementById('outKelas').textContent = document.getElementById('kelas').value || 'â€”';
  document.getElementById('outSesi').textContent = (document.getElementById('sesi').value==='pagi'?'Pagi':'Petang');

  const tbl=document.getElementById('jadual'); tbl.innerHTML='';
  if(plan.days.length===0){ tbl.innerHTML='<tr><td style="padding:20px">Tiada hari dipilih.</td></tr>'; return; }

  const thead=el('thead'); const trh=el('tr'); trh.appendChild(el('th',{},'Hari / Masa'));
  // gunakan masa dari hari pertama (format sama untuk semua hari)
  const slotsRef=plan.slotsPerDay[0];
  slotsRef.forEach(s=> trh.appendChild(el('th',{}, `${s.start}â€“${s.end}${s.type==='recess'?' (Rehat)':''}` )));
  thead.appendChild(trh); tbl.appendChild(thead);

  const tbody=el('tbody');
  plan.grid.forEach((row,di)=>{
    const tr=el('tr');
    tr.appendChild(el('th',{}, plan.days[di].name));
    row.forEach((cell,si)=>{
      const td=el('td',{});
      if(cell.type==='recess'){ td.textContent='REHAT'; td.classList.add('recess'); }
      else{
        td.textContent = cell.text || '';
        td.contentEditable = true;
        td.classList.add('editable');
        if(cell.type==='fixed') td.classList.add('fixed');
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);
}

/* ===== Auto-generate (debounced) ===== */
let debounceTimer=null;
function autoGenerate(){
  clearTimeout(debounceTimer);
  debounceTimer=setTimeout(()=>{ const plan=planWeek(); renderTable(plan); }, 120);
}
function manualGenerate(){ const plan=planWeek(); renderTable(plan); }

/* ===== Share / Save ===== */
function tableToText(){
  const t=document.getElementById('jadual'); if(!t.rows.length) return 'Jadual belum dijana.';
  let out=`Jadual ${document.getElementById('nama').value||''} (${document.getElementById('kelas').value||''}) â€“ ${(document.getElementById('sesi').value==='pagi'?'Sesi Pagi':'Sesi Petang')}\n`;
  const header=[...t.rows[0].cells].slice(1).map(c=>c.textContent.trim());
  for(let r=1;r<t.rows.length;r++){
    const hari=t.rows[r].cells[0].textContent.trim(); out+=`\n${hari}:\n`;
    for(let c=1;c<t.rows[r].cells.length;c++){
      const masa=header[c-1]; const teks=t.rows[r].cells[c].textContent.trim()||'-';
      out+=`  â€¢ ${masa}: ${teks}\n`;
    }
  }
  return out;
}
function shareWhatsApp(){ window.open(`https://wa.me/?text=${encodeURIComponent(tableToText())}`,'_blank'); }

function collectState(){
  return {
    meta:{
      nama:document.getElementById('nama').value,
      kelas:document.getElementById('kelas').value,
      sesi:document.getElementById('sesi').value,
      masaMula:document.getElementById('masaMula').value,
      panjangWaktu:+document.getElementById('panjangWaktu').value,
      bilWaktu:+document.getElementById('bilWaktu').value,
      minRehat:+document.getElementById('minRehat').value,
      rehatSelepas:+document.getElementById('rehatSelepas').value,
      hari:[...hariAktif]
    },
    subjects, fixedSlots,
    tableHTML: document.getElementById('jadual').innerHTML
  }
}
function applyState(d){
  if(d.meta){
    const m=d.meta;
    document.getElementById('nama').value=m.nama||'';
    document.getElementById('kelas').value=m.kelas||'';
    document.getElementById('sesi').value=m.sesi||'pagi';
    document.getElementById('masaMula').value=m.masaMula||'07:30';
    document.getElementById('panjangWaktu').value=m.panjangWaktu||30;
    document.getElementById('bilWaktu').value=m.bilWaktu||8;
    document.getElementById('minRehat').value=m.minRehat||30;
    document.getElementById('rehatSelepas').value=m.rehatSelepas||3;
    hariAktif = new Set(m.hari && m.hari.length? m.hari : HARI_DEFAULT);
    renderHariChips();
  }
  if(d.subjects){ subjects=d.subjects; renderSubjects(); }
  if(d.fixedSlots){ fixedSlots=d.fixedSlots; renderFixedSlots(); }
  if(d.tableHTML){ document.getElementById('jadual').innerHTML=d.tableHTML; }
  autoGenerate();
}
function saveState(){ localStorage.setItem('autoJadual', JSON.stringify(collectState())); alert('Disimpan pada peranti.'); }
function loadState(){ const raw=localStorage.getItem('autoJadual'); if(!raw) return alert('Tiada simpanan.'); applyState(JSON.parse(raw)); }
function exportJSON(){ const blob=new Blob([JSON.stringify(collectState(),null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='auto-jadual.json'; a.click(); }
function importJSON(){ const inp=document.createElement('input'); inp.type='file'; inp.accept='.json,application/json'; inp.onchange=()=>{ const f=inp.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{applyState(JSON.parse(r.result)); alert('JSON dimuatkan.')}catch{alert('Fail tidak sah.')} }; r.readAsText(f)}; inp.click(); }
function clearAll(){
  if(!confirm('Kosongkan semua?')) return;
  document.getElementById('nama').value='';
  document.getElementById('kelas').value='';
  document.getElementById('sesi').value='pagi';
  document.getElementById('masaMula').value='07:30';
  document.getElementById('panjangWaktu').value=30;
  document.getElementById('bilWaktu').value=8;
  document.getElementById('minRehat').value=30;
  document.getElementById('rehatSelepas').value=3;
  hariAktif = new Set(HARI_DEFAULT); renderHariChips();
  subjects=defaultSubjects(); renderSubjects();
  fixedSlots=[]; renderFixedSlots();
  document.getElementById('jadual').innerHTML='';
}

/* ===== Init & Event Wiring ===== */
function wireAuto(){
  const ids=['nama','kelas','sesi','masaMula','panjangWaktu','bilWaktu','minRehat','rehatSelepas'];
  ids.forEach(id=>{
    document.getElementById(id).addEventListener('input', autoGenerate);
    document.getElementById(id).addEventListener('change', autoGenerate);
  });
  // sesi sync masa mula
  document.getElementById('sesi').addEventListener('change', ()=>{
    document.getElementById('masaMula').value = document.getElementById('sesi').value==='pagi'?'07:30':'13:00';
  });
}
(function init(){
  renderHariChips();
  subjects=defaultSubjects(); renderSubjects();
  renderFixedSlots();
  wireAuto();
  autoGenerate(); // generate awal
})();
</script>
</body>
</html>
